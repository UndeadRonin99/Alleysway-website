@model XBCAD.ViewModels.AvailabilityViewModel
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container mt-4">
    <h2>Default Availability</h2>

    <div class="availability-section">
        <div class="section-header">
            <h3 class="section-title">General Availability</h3>
        </div>
        <div class="availability-table">
            @for (int dayIndex = 0; dayIndex < Model.Days.Count; dayIndex++)
            {
                var day = Model.Days[dayIndex];
                <div class="day-row">
                    <div class="day-name">@day.Day</div>
                    <div class="time-slots" data-day="@day.Day">
                        @if (day.TimeSlots != null && day.TimeSlots.Count > 0)
                        {
                            @for (int i = 0; i < day.TimeSlots.Count; i++)
                            {
                                <div class="time-slot d-flex align-items-center">
                                    <input type="text" class="form-control me-2 timepicker" value="@day.TimeSlots[i].StartTime" placeholder="Start Time" readonly>
                                    <span class="me-2">until</span>
                                    <input type="text" class="form-control me-2 timepicker" value="@day.TimeSlots[i].EndTime" placeholder="End Time" readonly>
                                    <button type="button" class="btn btn-danger me-2" onclick="removeTimeSlot(this, '@day.Day', '@day.TimeSlots[i].StartTime', '@day.TimeSlots[i].EndTime')">&#x1F5D1;</button>
                                </div>
                            }
                        }
                    </div>
                    <button type="button" class="btn btn-primary mt-2" onclick="addTimeSlot(this, '@day.Day')">+ Add Time</button>
                </div>
            }
        </div>
    </div>
</div>


    <!-- Block to display saved availability -->
    <div class="mt-5">
        <div class="mt-5">
            <h4>Current Availability</h4>
            <div class="saved-availability">
                @foreach (var day in Model.Days)
                {
                    <div class="card mb-3">
                        <div class="card-header custom-header">
                            <!-- Custom header color -->
                            <strong>@day.Day</strong>
                        </div>
                        <div class="card-body custom-body">
                            <!-- Custom body color -->
                            @if (day.TimeSlots != null && day.TimeSlots.Any())
                            {
                                <ul class="list-group">
                                    @foreach (var slot in day.TimeSlots)
                                    {
                                        <li class="list-group-item custom-list-item">@slot.StartTime - @slot.EndTime</li> <!-- Custom list item color -->
                                    }
                                </ul>
                            }
                            else
                            {
                                <p class="text-muted">No availability set for this day.</p>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>


@section Scripts {
    <script>
        function initializeTimePickers() {
            $(".timepicker").flatpickr({
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                time_24hr: true
            });
        }

        initializeTimePickers();
            function addTimeSlot(button, day) {
                var container = $(button).closest('.day-row').find('.time-slots');
                var timeSlotCount = container.children('.time-slot').length;

                var newSlot = $('<div class="time-slot d-flex align-items-center">' +
                    '<input type="text" class="form-control me-2 timepicker" placeholder="Start Time">' +
                    '<span class="me-2">until</span>' +
                    '<input type="text" class="form-control me-2 timepicker" placeholder="End Time">' +
                    '<button type="button" class="btn btn-danger me-2" onclick="removeTimeSlot(this, \'' + day + '\', \'\', \'\')">&#x1F5D1;</button>' +
                    '</div>');

                // Insert the new time slot before the "Add Time" button
                $(button).before(newSlot);
                initializeTimePickers();

                newSlot.find('.timepicker').change(function () {
                    var startTime = newSlot.find('.timepicker').eq(0).val();
                    var endTime = newSlot.find('.timepicker').eq(1).val();

                    if (startTime && endTime) {
                        $.ajax({
                            type: "POST",
                            url: '@Url.Action("SaveTimeSlot", "Admin")',
                            data: { day: day, startTime: startTime, endTime: endTime },
                            success: function () {
                                location.reload(); // Reload page to reflect saved availability
                            }
                        });
                    }
                });
            }


        function removeTimeSlot(button, day, startTime, endTime) {
            var slot = $(button).closest('.time-slot');
            slot.remove();

            if (startTime && endTime) {
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("RemoveTimeSlot", "Admin")',
                    data: { day: day, startTime: startTime, endTime: endTime },
                    success: function () {
                        location.reload(); // Reload page to reflect removed availability
                    }
                });
            }
        }
    </script>
}
